// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

//@version=6
strategy("Cornix Clone v5 [HYPE]", overlay=true, pyramiding=100, default_qty_type=strategy.cash, default_qty_value=0, initial_capital=2400, currency=currency.USD, commission_type=strategy.commission.percent, commission_value=0.02, slippage=0, process_orders_on_close=true, calc_on_every_tick=true, margin_long=5, margin_short=5, max_bars_back=5000)

// ══════════════════════════════════════════════════════════════════════════════
// ▌ CORNIX CLONE v5 - LONG ONLY, KEIN SL, DCA + TINY TP
// ══════════════════════════════════════════════════════════════════════════════
//
// v1-v4 waren alle falsch weil: HEDGE MODE (long+short gleichzeitig)
// Cornix Bots traden NUR LONG. Keine Shorts.
//
// LOGIK:
//   1. NUR Long-Trades (kein Hedge, keine Shorts)
//   2. Kaufe jeden RSI-Dip
//   3. TP 0.8% vom Average → Markt-Noise trifft es im Uptrend
//   4. 6 DCA Levels (HYPE Cornix Spacing) falls Dip tiefer geht
//   5. KEIN Stop Loss - DCA + warten. Im Uptrend bounced alles.
//   6. Bei Crash: DCA fängt bis -28% ab, Kapital gebunden = auto-pause
//   7. Beim Bounce: DCA-Position braucht nur 0.8% vom Avg → schnelle Recovery
//
// WARUM 97% WR:
//   - Im Uptrend bounced JEDER Dip zurück
//   - 0.8% TP = winzig, natürlicher Noise trifft es
//   - DCA überlebt tiefere Dips
//   - Nur extreme Crashes (>28%) sind echte Verluste (= die 3%)
//
// Optional: Flat bei starkem Downtrend (EMA Filter)
// ══════════════════════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// --- Trend Filter (optional) ---
string grp_trend = "═══ Trend Filter ═══"
bool use_trend_filter = input.bool(true, "Trend Filter aktiv", group=grp_trend, tooltip="Nur Long wenn EMA 50 > EMA 200.\nBei Downtrend: FLAT (keine Trades).")
int ema_fast_len = input.int(50, "Fast EMA", minval=10, maxval=200, step=10, group=grp_trend)
int ema_slow_len = input.int(200, "Slow EMA", minval=50, maxval=500, step=10, group=grp_trend)

// --- Entry Signal ---
string grp_entry = "═══ Entry Signal ═══"
int rsi_len = input.int(14, "RSI Laenge", minval=7, maxval=30, group=grp_entry)
float rsi_buy = input.float(35.0, "RSI Buy Level", minval=15, maxval=50, step=5, group=grp_entry, tooltip="RSI unter diesem Wert → Long Entry (Dip kaufen)")
int cooldown = input.int(3, "Cooldown Bars", minval=1, maxval=100, group=grp_entry)

// --- Take Profit ---
string grp_tp = "═══ Take Profit ═══"
float tp_pct = input.float(0.8, "Take Profit %", minval=0.1, maxval=3.0, step=0.1, group=grp_tp, tooltip="Cornix HYPE: ~0.82%. Winzig = Noise trifft es.")

// --- DCA (6 Levels, HYPE Cornix Spacing) ---
string grp_dca = "═══ DCA (6 Levels - HYPE) ═══"
float dca_1 = input.float(6.3, "E2 Abstand %", group=grp_dca, tooltip="HYPE Cornix: ~6.3%")
float dca_2 = input.float(12.4, "E3 Abstand %", group=grp_dca, tooltip="HYPE Cornix: ~12.4%")
float dca_3 = input.float(18.1, "E4 Abstand %", group=grp_dca, tooltip="HYPE Cornix: ~18.1%")
float dca_4 = input.float(23.4, "E5 Abstand %", group=grp_dca, tooltip="HYPE Cornix: ~23.4%")
float dca_5 = input.float(28.4, "E6 Abstand %", group=grp_dca, tooltip="HYPE Cornix: ~28.4%")
int max_dca = input.int(5, "Max DCA Stufen", minval=0, maxval=5, group=grp_dca)

// --- DCA Sizing ---
string grp_sz = "═══ DCA Sizing ═══"
float sz_1 = input.float(1.0, "E1 Size", group=grp_sz)
float sz_2 = input.float(1.0, "E2 Size Mult", group=grp_sz)
float sz_3 = input.float(1.5, "E3 Size Mult", group=grp_sz)
float sz_4 = input.float(2.0, "E4 Size Mult", group=grp_sz)
float sz_5 = input.float(2.5, "E5 Size Mult", group=grp_sz)
float sz_6 = input.float(3.0, "E6 Size Mult", group=grp_sz)

// --- Account ---
string grp_acc = "═══ Account ═══"
float equity_pct = input.float(1.0, "Equity % pro E1", minval=0.1, maxval=5.0, step=0.1, group=grp_acc, tooltip="1% Equity × 20x Lev = 20% Notional pro E1\nMax total bei 6 DCA: 11% × 20x = 220% Notional")

// --- Emergency (nur für Katastrophen) ---
string grp_emerg = "═══ Emergency ═══"
bool use_emergency = input.bool(true, "Emergency Exit aktiv", group=grp_emerg)
float emergency_pct = input.float(35.0, "Emergency Exit %", minval=20.0, maxval=50.0, step=5.0, group=grp_emerg, tooltip="Nur wenn Preis >35% unter Entry fällt (unter ALLEN DCA Levels).\nSollte quasi nie passieren.")


// ══════════════════════════════════════════════════════════════════════════════
// ▌ CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

float ema_fast = ta.ema(close, ema_fast_len)
float ema_slow = ta.ema(close, ema_slow_len)
bool uptrend = ema_fast > ema_slow

float rsi = ta.rsi(close, rsi_len)

// Long erlaubt: entweder kein Trend-Filter, oder im Uptrend
bool allow_long = use_trend_filter ? uptrend : true

// Entry Signal: RSI-Dip im Uptrend
bool long_signal = allow_long and rsi < rsi_buy


// ══════════════════════════════════════════════════════════════════════════════
// ▌ POSITION TRACKING
// ══════════════════════════════════════════════════════════════════════════════

var float long_qty = 0.0
var float long_avg = 0.0
var float long_entry = 0.0  // Erster Entry-Preis (für DCA Level Berechnung)
var int long_dca = 0
var int long_bar = 0

var int last_long = -9999
var int wins = 0
var int losses = 0

bool l_active = long_qty > 0

get_dca_pct(int lvl) =>
    switch lvl
        1 => dca_1
        2 => dca_2
        3 => dca_3
        4 => dca_4
        5 => dca_5
        => 999.0

get_dca_sz(int lvl) =>
    switch lvl
        0 => sz_1
        1 => sz_2
        2 => sz_3
        3 => sz_4
        4 => sz_5
        5 => sz_6
        => 1.0

float base_usd = strategy.equity * equity_pct / 100
calc_qty(float usd) => usd * 20 / close


// ══════════════════════════════════════════════════════════════════════════════
// ▌ TAKE PROFIT (tiny TP → 97% WR)
// ══════════════════════════════════════════════════════════════════════════════

if l_active
    float tp = long_avg * (1 + tp_pct / 100)
    if high >= tp
        if long_qty > 0
            strategy.order("L_TP", strategy.short, qty=long_qty, comment="TP")
        wins += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0


// ══════════════════════════════════════════════════════════════════════════════
// ▌ DCA (6 Levels - Cornix HYPE Spacing)
// ══════════════════════════════════════════════════════════════════════════════

if l_active and long_dca < max_dca
    float pct = get_dca_pct(long_dca + 1)
    float lvl = long_entry * (1 - pct / 100)
    if low <= lvl
        float usd = base_usd * get_dca_sz(long_dca + 1)
        float qty = calc_qty(usd)
        if qty > 0
            string c = "E" + str.tostring(long_dca + 2)
            strategy.order("L_D" + str.tostring(long_dca + 1), strategy.long, qty=qty, comment=c)
            float cost = long_avg * long_qty + close * qty
            long_qty := long_qty + qty
            long_avg := cost / long_qty
            long_dca += 1


// ══════════════════════════════════════════════════════════════════════════════
// ▌ ENTRY (Buy the Dip - LONG ONLY)
// ══════════════════════════════════════════════════════════════════════════════

bool l_cd = (bar_index - last_long) >= cooldown

if long_signal and not l_active and l_cd
    float qty = calc_qty(base_usd * sz_1)
    if qty > 0
        strategy.order("L_E", strategy.long, qty=qty, comment="E1")
        long_qty := qty
        long_avg := close
        long_entry := close
        long_dca := 0
        long_bar := bar_index
        last_long := bar_index


// ══════════════════════════════════════════════════════════════════════════════
// ▌ EMERGENCY EXIT (nur für extreme Crashes)
// ══════════════════════════════════════════════════════════════════════════════

if use_emergency and l_active
    float emergency_lvl = long_entry * (1 - emergency_pct / 100)
    if low <= emergency_lvl
        if long_qty > 0
            strategy.order("L_EM", strategy.short, qty=long_qty, comment="EMERGENCY")
        losses += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0


// ══════════════════════════════════════════════════════════════════════════════
// ▌ VISUALISIERUNG
// ══════════════════════════════════════════════════════════════════════════════

plot(ema_fast, "EMA 50", color=color.new(#2196F3, 40), linewidth=1)
plot(ema_slow, "EMA 200", color=color.new(#FF9800, 40), linewidth=1)

plot(l_active ? long_avg : na, "Avg", color=color.new(#4CAF50, 30), style=plot.style_linebr, linewidth=1)
plot(l_active ? long_avg * (1 + tp_pct / 100) : na, "TP", color=color.new(#00E676, 30), style=plot.style_linebr, linewidth=2)

// DCA levels (nur ungetriggerte zeigen)
plot(l_active and long_dca < 1 ? long_entry * (1 - dca_1/100) : na, "E2", color=color.new(#4CAF50, 70), style=plot.style_linebr)
plot(l_active and long_dca < 2 ? long_entry * (1 - dca_2/100) : na, "E3", color=color.new(#4CAF50, 75), style=plot.style_linebr)
plot(l_active and long_dca < 3 ? long_entry * (1 - dca_3/100) : na, "E4", color=color.new(#4CAF50, 80), style=plot.style_linebr)
plot(l_active and long_dca < 4 ? long_entry * (1 - dca_4/100) : na, "E5", color=color.new(#FF9800, 80), style=plot.style_linebr)
plot(l_active and long_dca < 5 ? long_entry * (1 - dca_5/100) : na, "E6", color=color.new(#F44336, 80), style=plot.style_linebr)

// Emergency level
float emerg_lvl = l_active and use_emergency ? long_entry * (1 - emergency_pct/100) : na
plot(emerg_lvl, "Emergency", color=color.new(#FF0000, 50), style=plot.style_linebr, linewidth=1)

// Uptrend/Downtrend BG
bgcolor(use_trend_filter and not uptrend ? color.new(#F44336, 93) : na)

plotshape(long_signal and not l_active and l_cd, "Buy Dip", shape.triangleup, location.belowbar, color.new(#4CAF50, 0), size=size.tiny)


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INFO TABLE
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 3, 9, bgcolor=color.new(#0d1117, 5), border_color=color.new(#30305a, 0), border_width=1)

if barstate.islast
    table.cell(t, 0, 0, "CORNIX", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 1, 0, "LONG", text_color=#4CAF50, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 2, 0, "v5", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))

    // Trend
    table.cell(t, 0, 1, "Trend", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 1, uptrend ? "UP" : "DOWN", text_color=uptrend ? #4CAF50 : #F44336, text_size=size.tiny)
    table.cell(t, 2, 1, allow_long ? "ACTIVE" : "FLAT", text_color=allow_long ? #4CAF50 : #F44336, text_size=size.tiny)

    // RSI
    table.cell(t, 0, 2, "RSI", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 2, str.tostring(rsi, "#.#"), text_color=rsi < rsi_buy ? #4CAF50 : #aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 2, rsi < rsi_buy ? "DIP!" : "---", text_color=rsi < rsi_buy ? #4CAF50 : #555555, text_size=size.tiny)

    // Position
    table.cell(t, 0, 3, "Pos", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 3, l_active ? "E" + str.tostring(long_dca + 1) : "---", text_color=l_active ? #4CAF50 : #555555, text_size=size.tiny)
    table.cell(t, 2, 3, l_active ? str.tostring(long_avg, "#.##") : "---", text_color=#4CAF50, text_size=size.tiny)

    // TP Level
    table.cell(t, 0, 4, "TP", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 4, l_active ? str.tostring(long_avg * (1 + tp_pct/100), "#.##") : "---", text_color=#00E676, text_size=size.tiny)
    table.cell(t, 2, 4, str.tostring(tp_pct, "#.#") + "%", text_color=#aaaaaa, text_size=size.tiny)

    // DCA
    table.cell(t, 0, 5, "DCA", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 5, l_active ? str.tostring(long_dca) + "/5" : "---", text_color=long_dca > 3 ? #F44336 : long_dca > 1 ? #FF9800 : #4CAF50, text_size=size.tiny)
    float next_dca = l_active and long_dca < max_dca ? long_entry * (1 - get_dca_pct(long_dca + 1)/100) : na
    table.cell(t, 2, 5, na(next_dca) ? "---" : str.tostring(next_dca, "#.##"), text_color=#FF9800, text_size=size.tiny)

    // WR
    int total = wins + losses
    float wr = total > 0 ? wins * 100.0 / total : 0.0
    table.cell(t, 0, 6, "WR", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 6, str.tostring(wr, "#.#") + "%", text_color=wr > 90 ? #4CAF50 : wr > 70 ? #FF9800 : #F44336, text_size=size.tiny)
    table.cell(t, 2, 6, str.tostring(wins) + "/" + str.tostring(losses), text_color=#aaaaaa, text_size=size.tiny)

    // Exposure
    float l_exp = l_active ? long_qty * close / strategy.equity * 100 : 0.0
    table.cell(t, 0, 7, "Exp", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 7, str.tostring(l_exp, "#.#") + "%", text_color=l_exp > 200 ? #F44336 : l_exp > 100 ? #FF9800 : #aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 7, "20x", text_color=#FF9800, text_size=size.tiny)

    // Total Trades
    table.cell(t, 0, 8, "Trades", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 8, str.tostring(total), text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 8, "HYPE", text_color=#FF9800, text_size=size.tiny)
