// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

//@version=6
strategy("Cornix Clone v6 [HYPE]", overlay=true, pyramiding=100, default_qty_type=strategy.cash, default_qty_value=0, initial_capital=2400, currency=currency.USD, commission_type=strategy.commission.percent, commission_value=0.02, slippage=0, process_orders_on_close=true, calc_on_every_tick=true, margin_long=5, margin_short=5, max_bars_back=5000)

// ══════════════════════════════════════════════════════════════════════════════
// ▌ CORNIX CLONE v6 - ENDLICH RICHTIG
// ══════════════════════════════════════════════════════════════════════════════
//
// Reverse-engineered aus VERLUST-Trades (grösste Losses):
//
// LOSS TRADES (Stop = Avg - 1.5%):
//   XMR: E1=285.69, E2=277.37 → Avg=281.53, Stop=275.86 = Avg-2.0%
//   HYPE: E1=31.954, E2=29.881 → Avg=30.918, Stop=30.467 = Avg-1.5%
//
// WIN TRADES MIT DEEP DCA (Stop ÜBER Avg!):
//   HYPE: E1-E5 gefüllt, Avg=29.16, Stop=29.311 = Avg+0.52% (PROFIT!)
//   XMR: E1-E5 gefüllt, Avg=346.14, Stop=348.97 = Avg+0.82% (PROFIT!)
//
// DCA SIZING = EXPONENTIELL (2er-Potenzen!):
//   E1=1x, E2=2x, E3=4x, E4=8x, E5=16x, E6=32x
//   Verifiziert: HYPE 8.59, 17.19, 34.38, 68.78, 137.6 = exakt 1:2:4:8:16
//   XMR identisch: 8.67, 17.35, 34.81, 69.95, 139.9 = exakt 1:2:4:8:16
//
// MECHANISMUS:
//   1. LONG ONLY (kein Short)
//   2. Immer in einem Trade (sofort wieder rein nach TP)
//   3. TP = Avg + 0.8%
//   4. DCA: 6 Levels, exponentiell (1x→32x)
//   5. Stop = Avg - 1.5% (NACH DCA-Check!)
//   6. DCA füllt VOR Stop (wie Exchange: Limit füllt vor Trail)
//   7. Nach DCA: Avg sinkt massiv wegen exponentieller Sizing
//   8. Kleiner Bounce → Stop über Avg → Profit!
//
// WARUM EXPONENTIELL DER SCHLÜSSEL IST:
//   Mit altem Sizing (1,1,1.5,2,2.5,3): Avg sinkt langsam
//   Mit Cornix Sizing (1,2,4,8,16,32): E5 dominiert, Avg ≈ E5-Preis
//   → Winziger Bounce reicht für TP oder Profit-Stop
// ══════════════════════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// --- Trend Filter ---
string grp_trend = "═══ Trend Filter ═══"
bool use_trend_filter = input.bool(false, "Trend Filter (EMA)", group=grp_trend, tooltip="Optional: Nur Long bei EMA 50>200.\nAUS = immer traden (wie Cornix).\nAN = flat bei Downtrend.")
int ema_fast_len = input.int(50, "Fast EMA", minval=10, maxval=200, step=10, group=grp_trend)
int ema_slow_len = input.int(200, "Slow EMA", minval=50, maxval=500, step=10, group=grp_trend)

// --- Take Profit ---
string grp_tp = "═══ Take Profit ═══"
float tp_pct = input.float(0.8, "Take Profit % vom Avg", minval=0.1, maxval=3.0, step=0.1, group=grp_tp)

// --- Stop Loss (vom Average!) ---
string grp_sl = "═══ Stop Loss ═══"
float sl_pct = input.float(1.5, "Stop Loss % unter Avg", minval=0.5, maxval=5.0, step=0.1, group=grp_sl, tooltip="HYPE Cornix Loss: Stop = Avg - 1.5%\nXMR Cornix Loss: Stop = Avg - 2.0%\nWird NACH DCA-Check geprüft!")

// --- DCA (6 Levels, HYPE Spacing) ---
string grp_dca = "═══ DCA (6 Levels) ═══"
float dca_1 = input.float(6.3, "E2 Abstand %", group=grp_dca)
float dca_2 = input.float(12.4, "E3 Abstand %", group=grp_dca)
float dca_3 = input.float(18.1, "E4 Abstand %", group=grp_dca)
float dca_4 = input.float(23.4, "E5 Abstand %", group=grp_dca)
float dca_5 = input.float(28.4, "E6 Abstand %", group=grp_dca)
int max_dca = input.int(5, "Max DCA Stufen", minval=0, maxval=5, group=grp_dca)

// --- DCA Sizing ---
string grp_sz = "═══ DCA Sizing ═══"
float sz_1 = input.float(1.0, "E1 Size", group=grp_sz)
float sz_2 = input.float(2.0, "E2 Size Mult", group=grp_sz, tooltip="Cornix: EXAKT 2x E1 (verifiziert aus Screenshots)")
float sz_3 = input.float(4.0, "E3 Size Mult", group=grp_sz, tooltip="Cornix: EXAKT 4x E1")
float sz_4 = input.float(8.0, "E4 Size Mult", group=grp_sz, tooltip="Cornix: EXAKT 8x E1")
float sz_5 = input.float(16.0, "E5 Size Mult", group=grp_sz, tooltip="Cornix: EXAKT 16x E1")
float sz_6 = input.float(32.0, "E6 Size Mult", group=grp_sz, tooltip="Cornix: EXAKT 32x E1 (extrapoliert)")

// --- Account ---
string grp_acc = "═══ Account ═══"
float equity_pct = input.float(0.5, "Equity % pro E1", minval=0.1, maxval=5.0, step=0.1, group=grp_acc, tooltip="KLEIN! Exponentielles DCA:\nE1-E6 = 1+2+4+8+16+32 = 63x\n0.5% × 63 × 20x = 630% max Notional\nSelten: E5+ passiert fast nie")
int cooldown = input.int(1, "Cooldown Bars nach TP/SL", minval=0, maxval=10, group=grp_acc, tooltip="Wie schnell nach Schliessung wieder rein.\n1 = nächster Bar (quasi sofort)")


// ══════════════════════════════════════════════════════════════════════════════
// ▌ CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

float ema_fast = ta.ema(close, ema_fast_len)
float ema_slow = ta.ema(close, ema_slow_len)
bool uptrend = ema_fast > ema_slow
bool allow_long = use_trend_filter ? uptrend : true


// ══════════════════════════════════════════════════════════════════════════════
// ▌ POSITION TRACKING
// ══════════════════════════════════════════════════════════════════════════════

var float long_qty = 0.0
var float long_avg = 0.0
var float long_entry = 0.0
var int long_dca = 0
var int long_bar = 0
var bool dca_this_bar = false  // DCA auf diesem Bar? → Stop-Check skippen

var int last_close = -9999
var int wins = 0
var int losses = 0

bool l_active = long_qty > 0

get_dca_pct(int lvl) =>
    switch lvl
        1 => dca_1
        2 => dca_2
        3 => dca_3
        4 => dca_4
        5 => dca_5
        => 999.0

get_dca_sz(int lvl) =>
    switch lvl
        0 => sz_1
        1 => sz_2
        2 => sz_3
        3 => sz_4
        4 => sz_5
        5 => sz_6
        => 1.0

float base_usd = strategy.equity * equity_pct / 100
calc_qty(float usd) => usd * 20 / close


// ══════════════════════════════════════════════════════════════════════════════
// ▌ SCHRITT 1: TAKE PROFIT
// ══════════════════════════════════════════════════════════════════════════════

if l_active
    float tp = long_avg * (1 + tp_pct / 100)
    if high >= tp
        if long_qty > 0
            strategy.order("TP", strategy.short, qty=long_qty, comment="TP")
        wins += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0
        last_close := bar_index


// ══════════════════════════════════════════════════════════════════════════════
// ▌ SCHRITT 2: DCA (VOR Stop-Check!)
// ══════════════════════════════════════════════════════════════════════════════

dca_this_bar := false

if l_active and long_dca < max_dca
    float pct = get_dca_pct(long_dca + 1)
    float lvl = long_entry * (1 - pct / 100)
    // DCA füllt DURCH den Stop hindurch (wie Cornix: Limit Order füllt vor Trail)
    if low <= lvl
        float usd = base_usd * get_dca_sz(long_dca + 1)
        float qty = calc_qty(usd)
        if qty > 0
            string c = "E" + str.tostring(long_dca + 2)
            strategy.order("DCA" + str.tostring(long_dca + 1), strategy.long, qty=qty, comment=c)
            float cost = long_avg * long_qty + close * qty
            long_qty := long_qty + qty
            long_avg := cost / long_qty
            long_dca += 1
            dca_this_bar := true  // Stop-Check auf diesem Bar skippen


// ══════════════════════════════════════════════════════════════════════════════
// ▌ SCHRITT 3: STOP LOSS (Avg - 1.5%, NACH DCA!)
// ══════════════════════════════════════════════════════════════════════════════

if l_active and not dca_this_bar and bar_index > long_bar
    float sl = long_avg * (1 - sl_pct / 100)
    if low <= sl
        if long_qty > 0
            strategy.order("SL", strategy.short, qty=long_qty, comment="SL")
        losses += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0
        last_close := bar_index


// ══════════════════════════════════════════════════════════════════════════════
// ▌ SCHRITT 4: ENTRY (immer, sobald kein Trade offen)
// ══════════════════════════════════════════════════════════════════════════════

bool can_enter = not l_active and allow_long and (bar_index - last_close) >= cooldown

if can_enter
    float qty = calc_qty(base_usd * sz_1)
    if qty > 0
        strategy.order("E1", strategy.long, qty=qty, comment="E1")
        long_qty := qty
        long_avg := close
        long_entry := close
        long_dca := 0
        long_bar := bar_index


// ══════════════════════════════════════════════════════════════════════════════
// ▌ VISUALISIERUNG
// ══════════════════════════════════════════════════════════════════════════════

plot(use_trend_filter ? ema_fast : na, "EMA 50", color=color.new(#2196F3, 40), linewidth=1)
plot(use_trend_filter ? ema_slow : na, "EMA 200", color=color.new(#FF9800, 40), linewidth=1)

plot(l_active ? long_avg : na, "Avg", color=color.new(#4CAF50, 20), style=plot.style_linebr, linewidth=2)
plot(l_active ? long_avg * (1 + tp_pct / 100) : na, "TP", color=color.new(#00E676, 30), style=plot.style_linebr, linewidth=2)
plot(l_active ? long_avg * (1 - sl_pct / 100) : na, "SL", color=color.new(#F44336, 30), style=plot.style_linebr, linewidth=2)

// DCA levels (immer zeigen - DCA füllt durch Stop hindurch)
plot(l_active and long_dca < 1 ? long_entry * (1 - dca_1/100) : na, "E2", color=color.new(#4CAF50, 70), style=plot.style_linebr)
plot(l_active and long_dca < 2 ? long_entry * (1 - dca_2/100) : na, "E3", color=color.new(#4CAF50, 75), style=plot.style_linebr)
plot(l_active and long_dca < 3 ? long_entry * (1 - dca_3/100) : na, "E4", color=color.new(#4CAF50, 80), style=plot.style_linebr)
plot(l_active and long_dca < 4 ? long_entry * (1 - dca_4/100) : na, "E5", color=color.new(#FF9800, 80), style=plot.style_linebr)
plot(l_active and long_dca < 5 ? long_entry * (1 - dca_5/100) : na, "E6", color=color.new(#F44336, 80), style=plot.style_linebr)

bgcolor(use_trend_filter and not uptrend ? color.new(#F44336, 93) : na)


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INFO TABLE
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 3, 9, bgcolor=color.new(#0d1117, 5), border_color=color.new(#30305a, 0), border_width=1)

if barstate.islast
    table.cell(t, 0, 0, "CORNIX", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 1, 0, "LONG", text_color=#4CAF50, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 2, 0, "v6", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))

    // Status
    table.cell(t, 0, 1, "Status", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 1, l_active ? "IN TRADE" : "WAITING", text_color=l_active ? #4CAF50 : #FF9800, text_size=size.tiny)
    table.cell(t, 2, 1, l_active ? "E" + str.tostring(long_dca + 1) : "---", text_color=#4CAF50, text_size=size.tiny)

    // Avg + TP + SL
    table.cell(t, 0, 2, "Avg", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 2, l_active ? str.tostring(long_avg, "#.##") : "---", text_color=#4CAF50, text_size=size.tiny)
    table.cell(t, 2, 2, "", text_color=#aaaaaa, text_size=size.tiny)

    table.cell(t, 0, 3, "TP", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 3, l_active ? str.tostring(long_avg * (1 + tp_pct/100), "#.##") : "---", text_color=#00E676, text_size=size.tiny)
    table.cell(t, 2, 3, "+" + str.tostring(tp_pct, "#.#") + "%", text_color=#00E676, text_size=size.tiny)

    table.cell(t, 0, 4, "SL", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 4, l_active ? str.tostring(long_avg * (1 - sl_pct/100), "#.##") : "---", text_color=#F44336, text_size=size.tiny)
    table.cell(t, 2, 4, "-" + str.tostring(sl_pct, "#.#") + "%", text_color=#F44336, text_size=size.tiny)

    // DCA
    table.cell(t, 0, 5, "DCA", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 5, l_active ? str.tostring(long_dca) + "/5" : "---", text_color=long_dca > 3 ? #F44336 : long_dca > 1 ? #FF9800 : #4CAF50, text_size=size.tiny)
    float next_dca = l_active and long_dca < max_dca ? long_entry * (1 - get_dca_pct(long_dca + 1)/100) : na
    table.cell(t, 2, 5, na(next_dca) ? "---" : str.tostring(next_dca, "#.##"), text_color=#FF9800, text_size=size.tiny)

    // WR
    int total = wins + losses
    float wr = total > 0 ? wins * 100.0 / total : 0.0
    table.cell(t, 0, 6, "WR", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 6, str.tostring(wr, "#.#") + "%", text_color=wr > 90 ? #4CAF50 : wr > 70 ? #FF9800 : #F44336, text_size=size.tiny)
    table.cell(t, 2, 6, str.tostring(wins) + "/" + str.tostring(losses), text_color=#aaaaaa, text_size=size.tiny)

    // Trades
    table.cell(t, 0, 7, "Total", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 7, str.tostring(total), text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 7, "20x", text_color=#FF9800, text_size=size.tiny)

    // Exposure
    float l_exp = l_active ? long_qty * close / strategy.equity * 100 : 0.0
    table.cell(t, 0, 8, "Exp", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 8, str.tostring(l_exp, "#.#") + "%", text_color=l_exp > 200 ? #F44336 : #aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 8, "HYPE", text_color=#FF9800, text_size=size.tiny)
