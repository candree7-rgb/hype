// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

//@version=6
strategy("Cornix Clone v4 [HYPE]", overlay=true, pyramiding=100, default_qty_type=strategy.cash, default_qty_value=0, initial_capital=2400, currency=currency.USD, commission_type=strategy.commission.percent, commission_value=0.02, slippage=0, process_orders_on_close=true, calc_on_every_tick=true, margin_long=5, margin_short=5, max_bars_back=5000)

// ══════════════════════════════════════════════════════════════════════════════
// ▌ CORNIX CLONE v4 - PURE TRAILING STOP AB ENTRY
// ══════════════════════════════════════════════════════════════════════════════
//
// v1-v3 waren alle falsch. Cornix ist EINFACH:
//
// 1. Enter
// 2. Trailing Stop 0.25% ab Entry (SOFORT aktiv, kein Threshold)
// 3. TP 0.8%
// 4. DCA nur als Backup für Gaps (wird fast nie gebraucht)
//
// Beweis aus Cornix-Screenshots:
//   Trade 2: Peak ~34.45, SL = 34.45 × 0.9975 = 34.364 → Cornix: 34.362 ✓
//   Trade 1: Peak ~31.50, SL = 31.50 × 0.9975 = 31.421 → Cornix: 31.42  ✓
//
// E2-E6 werden gecancelled weil Trail SL ÜBER DCA-Levels zieht
// → "Price Is Below Stop Price"
// → DCA wird zu 97% nie gebraucht
//
// Warum 97% WR: 0.8% TP vs 0.25% Trail = 3.2:1 R:R
// Preis muss nur leicht in die richtige Richtung → TP hit.
// Wenn falsch → Trail stoppt schnell bei max -0.25%.
// ══════════════════════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// --- Direction ---
string grp_dir = "═══ Direction ═══"
int ema_fast_len = input.int(50, "Fast EMA", minval=10, maxval=200, step=10, group=grp_dir)
int ema_slow_len = input.int(200, "Slow EMA", minval=50, maxval=500, step=10, group=grp_dir)
int adx_len = input.int(14, "ADX Laenge", minval=7, maxval=30, group=grp_dir)
int adx_smooth = input.int(14, "ADX Smoothing", minval=7, maxval=30, group=grp_dir)
float adx_range_thresh = input.float(20.0, "ADX Ranging Schwelle", minval=10, maxval=30, step=1, group=grp_dir)

// --- Entry Signal ---
string grp_entry = "═══ Entry Signal ═══"
int rsi_len = input.int(14, "RSI Laenge", minval=7, maxval=30, group=grp_entry)
float rsi_buy = input.float(35.0, "RSI Buy Level", minval=15, maxval=45, step=5, group=grp_entry)
float rsi_sell = input.float(65.0, "RSI Sell Level", minval=55, maxval=85, step=5, group=grp_entry)
int cooldown = input.int(3, "Cooldown Bars", minval=1, maxval=100, group=grp_entry)

// --- Take Profit ---
string grp_tp = "═══ Take Profit ═══"
float tp_pct = input.float(0.8, "Take Profit %", minval=0.1, maxval=3.0, step=0.1, group=grp_tp)

// --- Trailing Stop (Cornix-Stil: AB ENTRY, 0.25%) ---
string grp_trail = "═══ Trailing Stop ═══"
float trail_pct = input.float(0.25, "Trail Abstand %", minval=0.05, maxval=1.0, step=0.05, group=grp_trail, tooltip="Cornix berechnet: ~0.25%\nTrail 2: 34.45 × 0.9975 = 34.364 (Cornix: 34.362)\nTrade 1: 31.50 × 0.9975 = 31.421 (Cornix: 31.42)")

// --- DCA (Backup für Gaps - wird fast nie gebraucht) ---
string grp_dca = "═══ DCA (Backup) ═══"
bool use_dca = input.bool(true, "DCA aktivieren", group=grp_dca, tooltip="Nur für Flash-Crashes wo Preis durch Trail springt")
float dca_1 = input.float(6.3, "E2 Abstand %", group=grp_dca)
float dca_2 = input.float(12.4, "E3 Abstand %", group=grp_dca)
float dca_3 = input.float(18.1, "E4 Abstand %", group=grp_dca)
float dca_4 = input.float(23.4, "E5 Abstand %", group=grp_dca)
float dca_5 = input.float(28.4, "E6 Abstand %", group=grp_dca)
int max_dca = input.int(5, "Max DCA Stufen", minval=0, maxval=5, group=grp_dca)

// --- DCA Sizing ---
string grp_sz = "═══ DCA Sizing ═══"
float sz_1 = input.float(1.0, "E1 Size", group=grp_sz)
float sz_2 = input.float(1.0, "E2 Size Mult", group=grp_sz)
float sz_3 = input.float(1.5, "E3 Size Mult", group=grp_sz)
float sz_4 = input.float(2.0, "E4 Size Mult", group=grp_sz)
float sz_5 = input.float(2.5, "E5 Size Mult", group=grp_sz)
float sz_6 = input.float(3.0, "E6 Size Mult", group=grp_sz)

// --- Account ---
string grp_acc = "═══ Account ═══"
float equity_pct = input.float(1.0, "Equity % pro E1", minval=0.1, maxval=5.0, step=0.1, group=grp_acc)


// ══════════════════════════════════════════════════════════════════════════════
// ▌ CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

float ema_fast = ta.ema(close, ema_fast_len)
float ema_slow = ta.ema(close, ema_slow_len)
bool uptrend = ema_fast > ema_slow
bool downtrend = ema_fast < ema_slow

[di_plus, di_minus, adx_val] = ta.dmi(adx_len, adx_smooth)
bool is_ranging = adx_val < adx_range_thresh

float rsi = ta.rsi(close, rsi_len)

bool allow_long = uptrend or is_ranging
bool allow_short = downtrend or is_ranging

bool long_signal = allow_long and rsi < rsi_buy
bool short_signal = allow_short and rsi > rsi_sell


// ══════════════════════════════════════════════════════════════════════════════
// ▌ POSITION TRACKING
// ══════════════════════════════════════════════════════════════════════════════

var float long_qty = 0.0
var float long_avg = 0.0
var float long_entry = 0.0
var int long_dca = 0
var int long_bar = 0
var float long_peak = 0.0          // Höchster Preis seit Entry

var float short_qty = 0.0
var float short_avg = 0.0
var float short_entry = 0.0
var int short_dca = 0
var int short_bar = 0
var float short_trough = 9999999.0 // Tiefster Preis seit Entry

var int last_long = -9999
var int last_short = -9999
var int wins = 0
var int losses = 0

bool l_active = long_qty > 0
bool s_active = short_qty > 0

get_dca_pct(int lvl) =>
    switch lvl
        1 => dca_1
        2 => dca_2
        3 => dca_3
        4 => dca_4
        5 => dca_5
        => 999.0

get_dca_sz(int lvl) =>
    switch lvl
        0 => sz_1
        1 => sz_2
        2 => sz_3
        3 => sz_4
        4 => sz_5
        5 => sz_6
        => 1.0

float base_usd = strategy.equity * equity_pct / 100
calc_qty(float usd) => usd * 20 / close


// ══════════════════════════════════════════════════════════════════════════════
// ▌ TRAILING STOP UPDATE (jeden Bar!)
// ══════════════════════════════════════════════════════════════════════════════

// Long: track peak
if l_active and bar_index > long_bar
    if high > long_peak
        long_peak := high

// Short: track trough
if s_active and bar_index > short_bar
    if low < short_trough
        short_trough := low


// ══════════════════════════════════════════════════════════════════════════════
// ▌ TAKE PROFIT
// ══════════════════════════════════════════════════════════════════════════════

if l_active
    float tp = long_avg * (1 + tp_pct / 100)
    if high >= tp
        if long_qty > 0
            strategy.order("L_TP", strategy.short, qty=long_qty, comment="L TP")
        wins += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0
        long_peak := 0.0

if s_active
    float tp = short_avg * (1 - tp_pct / 100)
    if low <= tp
        if short_qty > 0
            strategy.order("S_TP", strategy.long, qty=short_qty, comment="S TP")
        wins += 1
        short_qty := 0.0
        short_avg := 0.0
        short_entry := 0.0
        short_dca := 0
        short_trough := 9999999.0


// ══════════════════════════════════════════════════════════════════════════════
// ▌ TRAILING STOP EXIT
// ══════════════════════════════════════════════════════════════════════════════

// Long: Trail SL = peak × (1 - trail_pct%)
if l_active and bar_index > long_bar and long_peak > 0
    float trail_sl = long_peak * (1 - trail_pct / 100)
    if low <= trail_sl
        if long_qty > 0
            strategy.order("L_TS", strategy.short, qty=long_qty, comment="L Trail")
        if trail_sl >= long_avg
            wins += 1
        else
            losses += 1
        long_qty := 0.0
        long_avg := 0.0
        long_entry := 0.0
        long_dca := 0
        long_peak := 0.0

// Short: Trail SL = trough × (1 + trail_pct%)
if s_active and bar_index > short_bar and short_trough < 9999999.0
    float trail_sl = short_trough * (1 + trail_pct / 100)
    if high >= trail_sl
        if short_qty > 0
            strategy.order("S_TS", strategy.long, qty=short_qty, comment="S Trail")
        if trail_sl <= short_avg
            wins += 1
        else
            losses += 1
        short_qty := 0.0
        short_avg := 0.0
        short_entry := 0.0
        short_dca := 0
        short_trough := 9999999.0


// ══════════════════════════════════════════════════════════════════════════════
// ▌ DCA (Backup - nur wenn Preis durch Trail springt)
// ══════════════════════════════════════════════════════════════════════════════

if use_dca and l_active and long_dca < max_dca
    float pct = get_dca_pct(long_dca + 1)
    float lvl = long_entry * (1 - pct / 100)
    if low <= lvl
        float usd = base_usd * get_dca_sz(long_dca + 1)
        float qty = calc_qty(usd)
        if qty > 0
            string c = "L E" + str.tostring(long_dca + 2)
            strategy.order("L_D" + str.tostring(long_dca + 1), strategy.long, qty=qty, comment=c)
            float cost = long_avg * long_qty + close * qty
            long_qty := long_qty + qty
            long_avg := cost / long_qty
            long_dca += 1
            // Reset peak nach DCA (neuer Avg)
            long_peak := high

if use_dca and s_active and short_dca < max_dca
    float pct = get_dca_pct(short_dca + 1)
    float lvl = short_entry * (1 + pct / 100)
    if high >= lvl
        float usd = base_usd * get_dca_sz(short_dca + 1)
        float qty = calc_qty(usd)
        if qty > 0
            string c = "S E" + str.tostring(short_dca + 2)
            strategy.order("S_D" + str.tostring(short_dca + 1), strategy.short, qty=qty, comment=c)
            float cost = short_avg * short_qty + close * qty
            short_qty := short_qty + qty
            short_avg := cost / short_qty
            short_dca += 1
            short_trough := low


// ══════════════════════════════════════════════════════════════════════════════
// ▌ ENTRIES
// ══════════════════════════════════════════════════════════════════════════════

bool l_cd = (bar_index - last_long) >= cooldown
bool s_cd = (bar_index - last_short) >= cooldown

if long_signal and not l_active and l_cd
    float qty = calc_qty(base_usd * sz_1)
    if qty > 0
        strategy.order("L_E", strategy.long, qty=qty, comment="L E1")
        long_qty := qty
        long_avg := close
        long_entry := close
        long_dca := 0
        long_bar := bar_index
        last_long := bar_index
        long_peak := close  // Peak startet bei Entry

if short_signal and not s_active and s_cd
    float qty = calc_qty(base_usd * sz_1)
    if qty > 0
        strategy.order("S_E", strategy.short, qty=qty, comment="S E1")
        short_qty := qty
        short_avg := close
        short_entry := close
        short_dca := 0
        short_bar := bar_index
        last_short := bar_index
        short_trough := close  // Trough startet bei Entry


// ══════════════════════════════════════════════════════════════════════════════
// ▌ VISUALISIERUNG
// ══════════════════════════════════════════════════════════════════════════════

plot(ema_fast, "EMA 50", color=color.new(#2196F3, 40), linewidth=1)
plot(ema_slow, "EMA 200", color=color.new(#FF9800, 40), linewidth=1)

plot(l_active ? long_avg : na, "L Avg", color=color.new(#4CAF50, 30), style=plot.style_linebr, linewidth=1)
plot(s_active ? short_avg : na, "S Avg", color=color.new(#F44336, 30), style=plot.style_linebr, linewidth=1)

// TP Level
plot(l_active ? long_avg * (1 + tp_pct / 100) : na, "L TP", color=color.new(#4CAF50, 50), style=plot.style_linebr, linewidth=2)
plot(s_active ? short_avg * (1 - tp_pct / 100) : na, "S TP", color=color.new(#F44336, 50), style=plot.style_linebr, linewidth=2)

// Trail SL Level (gelb)
float l_trail = l_active and long_peak > 0 ? long_peak * (1 - trail_pct / 100) : na
float s_trail = s_active and short_trough < 9999999.0 ? short_trough * (1 + trail_pct / 100) : na
plot(l_trail, "L Trail", color=color.new(#FFEB3B, 20), style=plot.style_linebr, linewidth=2)
plot(s_trail, "S Trail", color=color.new(#FFEB3B, 20), style=plot.style_linebr, linewidth=2)

bgcolor(is_ranging ? color.new(#9C27B0, 95) : uptrend ? color.new(#4CAF50, 96) : color.new(#F44336, 96))
plotshape(long_signal and not l_active and l_cd, "Buy", shape.triangleup, location.belowbar, color.new(#4CAF50, 0), size=size.tiny)
plotshape(short_signal and not s_active and s_cd, "Sell", shape.triangledown, location.abovebar, color.new(#F44336, 0), size=size.tiny)


// ══════════════════════════════════════════════════════════════════════════════
// ▌ INFO TABLE
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 4, 10, bgcolor=color.new(#0d1117, 5), border_color=color.new(#30305a, 0), border_width=1)

if barstate.islast
    table.cell(t, 0, 0, "CORNIX", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 1, 0, "CLONE", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 2, 0, "PURE", text_color=#FFEB3B, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))
    table.cell(t, 3, 0, "v4", text_color=#00d4ff, text_size=size.tiny, bgcolor=color.new(#0d1117, 0))

    string mode = is_ranging ? "RANGE" : uptrend ? "BULL" : "BEAR"
    color mc = is_ranging ? #9C27B0 : uptrend ? #4CAF50 : #F44336
    table.cell(t, 0, 1, "Mode", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 1, mode, text_color=mc, text_size=size.tiny)
    table.cell(t, 2, 1, "ADX", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 1, str.tostring(adx_val, "#.#"), text_color=mc, text_size=size.tiny)

    table.cell(t, 0, 2, "RSI", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 2, str.tostring(rsi, "#.#"), text_color=rsi < rsi_buy ? #4CAF50 : rsi > rsi_sell ? #F44336 : #aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 2, "Trail", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 2, str.tostring(trail_pct, "#.##") + "%", text_color=#FFEB3B, text_size=size.tiny)

    // Long info
    table.cell(t, 0, 3, "LONG", text_color=#4CAF50, text_size=size.tiny)
    table.cell(t, 1, 3, l_active ? "E" + str.tostring(long_dca + 1) : "---", text_color=l_active ? #4CAF50 : #555555, text_size=size.tiny)
    table.cell(t, 2, 3, "Peak", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 3, l_active ? str.tostring(long_peak, "#.##") : "---", text_color=#4CAF50, text_size=size.tiny)

    // Short info
    table.cell(t, 0, 4, "SHORT", text_color=#F44336, text_size=size.tiny)
    table.cell(t, 1, 4, s_active ? "E" + str.tostring(short_dca + 1) : "---", text_color=s_active ? #F44336 : #555555, text_size=size.tiny)
    table.cell(t, 2, 4, "Low", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 4, s_active ? str.tostring(short_trough, "#.##") : "---", text_color=#F44336, text_size=size.tiny)

    // Trail SL levels
    table.cell(t, 0, 5, "L SL", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 5, l_active and long_peak > 0 ? str.tostring(long_peak * (1 - trail_pct/100), "#.##") : "---", text_color=#FFEB3B, text_size=size.tiny)
    table.cell(t, 2, 5, "S SL", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 5, s_active and short_trough < 9999999.0 ? str.tostring(short_trough * (1 + trail_pct/100), "#.##") : "---", text_color=#FFEB3B, text_size=size.tiny)

    // Win/Loss
    int total = wins + losses
    float wr = total > 0 ? wins * 100.0 / total : 0.0
    table.cell(t, 0, 6, "WR", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 6, str.tostring(wr, "#.#") + "%", text_color=wr > 80 ? #4CAF50 : wr > 60 ? #FF9800 : #F44336, text_size=size.tiny)
    table.cell(t, 2, 6, "W/L", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 6, str.tostring(wins) + "/" + str.tostring(losses), text_color=#aaaaaa, text_size=size.tiny)

    // DCA depth
    table.cell(t, 0, 7, "L DCA", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 7, l_active ? str.tostring(long_dca) + "/5" : "---", text_color=#4CAF50, text_size=size.tiny)
    table.cell(t, 2, 7, "S DCA", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 7, s_active ? str.tostring(short_dca) + "/5" : "---", text_color=#F44336, text_size=size.tiny)

    // TP level
    table.cell(t, 0, 8, "L TP", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 8, l_active ? str.tostring(long_avg * (1 + tp_pct/100), "#.##") : "---", text_color=#4CAF50, text_size=size.tiny)
    table.cell(t, 2, 8, "S TP", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 8, s_active ? str.tostring(short_avg * (1 - tp_pct/100), "#.##") : "---", text_color=#F44336, text_size=size.tiny)

    // Exposure
    float l_exp = l_active ? long_qty * close / strategy.equity * 100 : 0.0
    float s_exp = s_active ? short_qty * close / strategy.equity * 100 : 0.0
    table.cell(t, 0, 9, "L Exp", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 1, 9, str.tostring(l_exp, "#.#") + "%", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 2, 9, "S Exp", text_color=#aaaaaa, text_size=size.tiny)
    table.cell(t, 3, 9, str.tostring(s_exp, "#.#") + "%", text_color=#aaaaaa, text_size=size.tiny)
